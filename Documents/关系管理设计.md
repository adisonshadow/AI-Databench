# 关系管理功能设计

## 概述

关系管理是ORM设计中的核心功能，用于管理实体之间的各种关系类型。本设计基于TypeORM的关系类型，提供可视化的关系创建、编辑和管理功能。

## 关系类型

### 1. 一对一关系 (OneToOne)
- **描述**：两个实体之间存在唯一的一对一关系
- **示例**：用户 ↔ 用户资料
- **特点**：每个用户只有一个资料，每个资料只属于一个用户
- **外键**：在任意一方创建外键字段

### 2. 一对多关系 (OneToMany)
- **描述**：一个实体可以关联多个另一个实体
- **示例**：用户 → 订单（一个用户可以有多个订单）
- **特点**：在"多"的一方创建外键字段
- **外键**：在"多"的一方创建外键

### 3. 多对一关系 (ManyToOne)
- **描述**：多个实体可以关联到同一个实体
- **示例**：订单 → 用户（多个订单属于同一个用户）
- **特点**：与OneToMany是同一关系的不同视角
- **外键**：在"多"的一方创建外键

### 4. 多对多关系 (ManyToMany)
- **描述**：两个实体之间存在多对多的关系
- **示例**：用户 ↔ 角色（用户可以有多个角色，角色可以被多个用户拥有）
- **特点**：需要中间表来存储关系
- **中间表**：自动创建或手动指定中间表

## 数据结构设计

### Relation 接口
```typescript
interface Relation {
  id: string;                    // 关系唯一标识
  type: RelationType;            // 关系类型
  name: string;                 // 关系名称
  inverseName?: string;          // 反向关系名称
  
  // 关系的两端
  from: {
    entityId: string;           // 源实体ID
    entityName: string;         // 源实体名称
    fieldId?: string;           // 源字段ID（可选）
    fieldName?: string;         // 源字段名称（可选）
  };
  to: {
    entityId: string;           // 目标实体ID
    entityName: string;         // 目标实体名称
    fieldId?: string;           // 目标字段ID（可选）
    fieldName?: string;         // 目标字段名称（可选）
  };
  
  // 关系配置
  config: {
    cascade: boolean;           // 级联操作
    onDelete: 'CASCADE' | 'SET NULL' | 'RESTRICT' | 'NO ACTION';
    onUpdate: 'CASCADE' | 'SET NULL' | 'RESTRICT' | 'NO ACTION';
    nullable: boolean;          // 是否可为空
    eager: boolean;             // 是否立即加载
    lazy: boolean;              // 是否懒加载
  };
  
  // 多对多关系特殊配置
  joinTable?: {
    name: string;               // 中间表名称
    joinColumn: string;         // 连接列名称
    inverseJoinColumn: string;   // 反向连接列名称
  };
  
  // 元数据
  metadata: {
    createdAt: string;
    updatedAt: string;
    createdBy: string;
    description?: string;       // 关系描述
    tags: string[];            // 标签
  };
}
```

### RelationType 枚举
```typescript
enum RelationType {
  ONE_TO_ONE = 'oneToOne',
  ONE_TO_MANY = 'oneToMany',
  MANY_TO_ONE = 'manyToOne',
  MANY_TO_MANY = 'manyToMany'
}
```

## 功能模块设计

### 1. 关系列表管理
- **功能**：显示所有关系，支持筛选、搜索、排序
- **操作**：创建、编辑、删除、复制关系
- **显示信息**：关系类型、源实体、目标实体、关系名称、状态

### 2. 关系创建向导
- **步骤1**：选择关系类型
- **步骤2**：选择源实体和目标实体
- **步骤3**：配置关系属性（名称、级联等）
- **步骤4**：预览和确认

### 3. 关系编辑
- **基本信息**：关系名称、描述、标签
- **配置选项**：级联操作、删除策略、更新策略
- **字段映射**：外键字段配置
- **中间表配置**：多对多关系的中间表设置

### 4. 关系验证
- **冲突检测**：检查关系冲突和循环依赖
- **完整性检查**：验证外键字段类型匹配
- **命名规范**：检查关系命名是否符合规范
- **性能影响**：分析关系对查询性能的影响

### 5. 关系可视化
- **关系图**：在ORM图谱中显示关系连线
- **关系详情**：悬停显示关系详细信息
- **关系编辑**：在图谱中直接编辑关系

### 6. 字段级关系配置
在字段管理界面中，支持对可以建立关系的字段类型直接配置关系：

#### 支持关系配置的字段类型
- **数字类型**：int, bigint（用于关联整数主键）
- **字符串类型**：varchar, char（用于关联字符串主键）
- **GUID类型**：adb-guid-id（用于关联GUID主键）

#### 字段关系配置界面
在添加/编辑字段时，对于支持关系配置的字段类型，提供以下配置选项：
- **关系类型**：选择一对一、一对多、多对一关系类型
- **目标实体**：选择要关联的目标实体
- **目标字段**：选择目标实体中的字段（通常是主键）
- **关系名称**：自动生成或自定义关系名称
- **级联操作**：配置级联保存、删除等操作
- **删除策略**：配置onDelete行为（CASCADE, SET NULL等）

## 用户界面设计

### 1. 关系管理主界面
```
┌─────────────────────────────────────────────────────────┐
│ 关系管理                                    [新建关系] │
├─────────────────────────────────────────────────────────┤
│ 筛选: [全部类型▼] [全部实体▼] [搜索框] [刷新]          │
├─────────────────────────────────────────────────────────┤
│ 关系列表                                                 │
│ ┌─────┬──────────┬──────────┬──────────┬──────────┬─────┐ │
│ │类型 │源实体    │目标实体  │关系名称  │状态      │操作 │ │
│ ├─────┼──────────┼──────────┼──────────┼──────────┼─────┤ │
│ │1:1  │User      │Profile   │profile   │启用      │编辑 │ │
│ │1:N  │User      │Order     │orders    │启用      │编辑 │ │
│ │N:N  │User      │Role      │roles     │启用      │编辑 │ │
│ └─────┴──────────┴──────────┴──────────┴──────────┴─────┘ │
└─────────────────────────────────────────────────────────┘
```

### 2. 关系创建向导
```
┌─────────────────────────────────────────────────────────┐
│ 创建关系 - 步骤 1/4                                      │
├─────────────────────────────────────────────────────────┤
│ 选择关系类型:                                           │
│ ○ 一对一 (OneToOne)                                     │
│ ○ 一对多 (OneToMany)                                   │
│ ○ 多对一 (ManyToOne)                                   │
│ ● 多对多 (ManyToMany)                                   │
│                                                         │
│ 关系描述: 用户和角色之间的多对多关系                    │
│                                                         │
│                    [上一步] [下一步]                    │
└─────────────────────────────────────────────────────────┘
```

### 3. 关系配置界面
```
┌─────────────────────────────────────────────────────────┐
│ 编辑关系: User ↔ Role                                   │
├─────────────────────────────────────────────────────────┤
│ 基本信息:                                               │
│ 关系名称: [userRoles]                                   │
│ 反向名称: [roleUsers]                                   │
│ 描述: [用户角色关系]                                    │
│                                                         │
│ 关系配置:                                               │
│ 级联操作: [✓] 启用                                      │
│ 删除策略: [CASCADE ▼]                                   │
│ 更新策略: [CASCADE ▼]                                   │
│ 可为空:   [✓] 是                                        │
│                                                         │
│ 中间表配置:                                             │
│ 表名: [user_role]                                       │
│ 连接列: [user_id]                                       │
│ 反向连接列: [role_id]                                   │
│                                                         │
│                    [取消] [保存]                        │
└─────────────────────────────────────────────────────────┘
```

### 4. 字段级关系配置界面
```
┌─────────────────────────────────────────────────────────┐
│ 字段配置: userId                                        │
├─────────────────────────────────────────────────────────┤
│ 基本信息:                                               │
│ 字段标识: [userId]                                      │
│ 显示名称: [用户ID]                                      │
│ 数据类型: [int ▼]                                       │
│                                                         │
│ [✓] 可为空  [ ] 唯一约束  [ ] 主键                      │
│                                                         │
│ 关系配置:                                               │
│ [✓] 建立关系                                            │
│ 关系类型: [多对一 ▼]                                    │
│ 目标实体: [User ▼]                                      │
│ 目标字段: [id ▼]                                        │
│ 关系名称: [user]                                        │
│                                                         │
│ 级联操作: [保存 ▼] [删除 ▼]                             │
│ 删除策略: [CASCADE ▼]                                   │
│                                                         │
│                    [取消] [保存]                        │
└─────────────────────────────────────────────────────────┘
```

## 技术实现

### 1. 组件结构
```
RelationManager/
├── index.tsx                 # 主组件
├── RelationList.tsx          # 关系列表
├── RelationForm.tsx          # 关系表单
├── RelationWizard.tsx         # 关系创建向导
├── RelationValidator.tsx      # 关系验证
├── FieldRelationConfig.tsx    # 字段级关系配置组件
└── types.ts                  # 类型定义
```

### 2. 工具函数
```typescript
// 关系管理工具函数
export class RelationUtils {
  // 创建关系
  static createRelation(config: RelationConfig): Relation;
  
  // 验证关系
  static validateRelation(relation: Relation): ValidationResult;
  
  // 检查关系冲突
  static checkConflicts(relation: Relation, existingRelations: Relation[]): Conflict[];
  
  // 生成关系代码
  static generateRelationCode(relation: Relation): string;
  
  // 获取关系建议
  static getRelationSuggestions(entities: Entity[]): RelationSuggestion[];
  
  // 字段关系配置
  static configureFieldRelation(field: Field, relationConfig: RelationConfig): FieldWithRelation;
}
```

### 3. 状态管理
```typescript
interface RelationState {
  relations: Relation[];
  selectedRelation: Relation | null;
  isCreating: boolean;
  isEditing: boolean;
  validationErrors: ValidationError[];
  conflicts: Conflict[];
  
  // 字段级关系配置状态
  fieldRelationConfig: {
    fieldId: string;
    isOpen: boolean;
    config: RelationConfig | null;
  };
}
```

## 验证规则

### 1. 关系完整性验证
- **实体存在性**：源实体和目标实体必须存在
- **字段类型匹配**：外键字段类型必须匹配主键类型
- **命名唯一性**：关系名称在实体中必须唯一
- **循环依赖**：不能创建循环依赖关系

### 2. 业务规则验证
- **一对一关系**：每个实体只能有一个一对一关系
- **外键约束**：外键字段不能是主键
- **中间表命名**：中间表名称不能与现有表冲突
- **级联操作**：级联删除不能导致数据丢失

### 3. 性能考虑
- **索引建议**：自动为外键字段创建索引
- **查询优化**：分析关系对查询性能的影响
- **懒加载**：建议使用懒加载避免N+1问题

## 集成点

### 1. 与实体管理集成
- **字段自动创建**：创建关系时自动创建外键字段
- **字段类型验证**：确保外键字段类型正确
- **字段删除检查**：删除字段前检查是否被关系使用

### 2. 与图谱视图集成
- **关系连线**：在图谱中显示关系连线
- **关系编辑**：在图谱中直接编辑关系
- **关系筛选**：在图谱中筛选显示特定关系

### 3. 与代码生成集成
- **TypeORM装饰器**：生成TypeORM关系装饰器
- **迁移脚本**：生成关系相关的迁移脚本
- **API生成**：生成关系查询的API接口

### 4. 与字段管理集成
- **字段级关系配置**：在字段编辑界面直接配置关系
- **关系类型适配**：根据字段类型显示适配的关系配置选项
- **lookup选择器**：提供目标实体和字段的选择界面

## 实现建议

### 1. 字段级关系配置实现
```typescript
// 字段级关系配置组件伪代码
const FieldRelationConfig: React.FC<FieldRelationConfigProps> = ({ 
  field, 
  entities,
  onConfigChange 
}) => {
  const [isRelationEnabled, setIsRelationEnabled] = useState(false);
  const [relationType, setRelationType] = useState<RelationType>();
  const [targetEntity, setTargetEntity] = useState<Entity>();
  const [targetField, setTargetField] = useState<Field>();
  
  // 当启用关系配置时
  const handleRelationToggle = (enabled: boolean) => {
    setIsRelationEnabled(enabled);
    if (enabled) {
      // 显示lookup选择器
      showEntityLookup();
    }
  };
  
  // 选择目标实体
  const handleEntitySelect = (entity: Entity) => {
    setTargetEntity(entity);
    // 自动选择目标实体的主键字段
    const primaryKey = getPrimaryKeyField(entity);
    setTargetField(primaryKey);
  };
  
  // 保存关系配置
  const handleSave = () => {
    const relationConfig: RelationConfig = {
      type: relationType,
      from: {
        entityId: currentEntity.id,
        fieldId: field.id
      },
      to: {
        entityId: targetEntity.id,
        fieldId: targetField.id
      }
    };
    
    onConfigChange(relationConfig);
  };
  
  return (
    <div>
      <Switch 
        checked={isRelationEnabled}
        onChange={handleRelationToggle}
      />
      
      {isRelationEnabled && (
        <div>
          <Select 
            value={relationType}
            onChange={setRelationType}
          >
            <Option value="manyToOne">多对一</Option>
            <Option value="oneToOne">一对一</Option>
          </Select>
          
          <Button onClick={() => showEntityLookup()}>
            选择目标实体
          </Button>
          
          {targetEntity && (
            <Select 
              value={targetField?.id}
              onChange={(fieldId) => {
                const field = targetEntity.fields.find(f => f.id === fieldId);
                setTargetField(field);
              }}
            >
              {targetEntity.fields.map(field => (
                <Option key={field.id} value={field.id}>
                  {field.name}
                </Option>
              ))}
            </Select>
          )}
        </div>
      )}
    </div>
  );
};
```

### 2. Lookup选择器实现
```typescript
// 实体选择lookup组件伪代码
const EntityLookup: React.FC<EntityLookupProps> = ({ 
  visible, 
  entities,
  onSelect,
  onCancel
}) => {
  const [searchText, setSearchText] = useState('');
  const [filteredEntities, setFilteredEntities] = useState(entities);
  
  // 搜索过滤
  useEffect(() => {
    const filtered = entities.filter(entity => 
      entity.name.toLowerCase().includes(searchText.toLowerCase()) ||
      entity.code.toLowerCase().includes(searchText.toLowerCase())
    );
    setFilteredEntities(filtered);
  }, [searchText, entities]);
  
  return (
    <Modal
      title="选择目标实体"
      open={visible}
      onCancel={onCancel}
      onOk={() => {/* 确认选择 */}}
    >
      <Input
        placeholder="搜索实体名称或代码"
        value={searchText}
        onChange={e => setSearchText(e.target.value)}
        prefix={<SearchOutlined />}
      />
      
      <List
        dataSource={filteredEntities}
        renderItem={entity => (
          <List.Item
            onClick={() => onSelect(entity)}
            style={{ cursor: 'pointer' }}
          >
            <List.Item.Meta
              title={entity.name}
              description={entity.code}
            />
          </List.Item>
        )}
      />
    </Modal>
  );
};
```

## 总结

关系管理功能是ORM设计的核心，需要提供直观的界面和强大的验证机制。通过分步骤的创建向导、详细的配置选项和实时的验证反馈，用户可以轻松创建和管理复杂的实体关系。同时，在字段管理界面中提供直接的关系配置功能，让用户可以在编辑字段时快速建立实体间的关系，提升用户体验和工作效率。