# AIDatabench 重构开发方案

## 项目概览

### 当前状况
- **旧项目位置**: `/Users/yanfang/MOM/BDC` (前后端分离架构)
- **核心依赖**: 
  - `AIModelApplicationSuite` - AI模型管理组件 (本地开发完成)
  - `ADB-TypeORM` - 增强型TypeORM框架 (本地开发完成)
- **技术债务**: UmiJS架构老旧，需要现代化升级

### 重构目标
1. **架构现代化** - 从UmiJS升级到Vite + React架构
2. **依赖集成** - 集成AIModelApplicationSuite核心组件
3. **功能增强** - 基于现有BDC功能扩展AI能力
4. **数据本地化** - 使用localStorage实现数据持久化
5. **简化架构** - 移除用户系统和复杂的数据库物化功能

## 技术架构重构

### 前端架构升级
```
旧架构: UmiJS 4.x + Ant Design Pro
新架构: Vite + React 18 + React Router + AIModelApplicationSuite组件
```

**Vite方案优势：**
- 构建速度极快，开发体验优秀，适合SPA后台管理系统
- 配置简单，学习成本低，迁移风险可控
- 与AIModelApplicationSuite组件完全兼容
- 轻量级，无SSR复杂性
- 更好的HMR（热模块替换）支持

**升级要点：**
- 保持Ant Design Pro组件库，实现平滑迁移
- 集成AIModelApplicationSuite提供AI模型管理界面
- 优化G6图谱组件的性能和交互体验
- 增强Monaco Editor和CodeMirror的代码编辑体验
- 使用React Router 6.x提供现代化路由管理
- 利用Vite的快速构建和热重载能力


**简化要点：**
- 移除用户登录和认证系统
- 使用localStorage作为唯一数据存储方案

## 核心模块重构计划

### 阶段一：基础架构搭建 (2-3周)

#### 1.1 项目初始化
- [ ] 创建新的前端项目结构 (Vite + React 18)
- [ ] 配置ADB-TypeORM本地依赖
- [ ] 配置AIModelApplicationSuite本地依赖
- [ ] 建立统一的类型定义和API接口
- [ ] 配置React Router 6.x路由系统

#### 1.2 核心组件迁移
- [ ] 实体设计器组件重构 (基于BDC现有实现)
- [ ] G6图谱组件集成和优化
- [ ] AI辅助设计功能集成
- [ ] 数据库连接管理组件

### 阶段二：功能模块迁移 (3-4周)

#### 2.1 ORM设计模块
- [ ] 实体设计器界面重构
- [ ] 关系映射设计器优化
- [ ] 实体状态管理 (启用/禁用/归档)
- [ ] localStorage数据持久化
- [ ] 实体代码生成功能

#### 2.2 数据本地化管理
- [ ] localStorage存储引擎开发
- [ ] 数据备份与恢复功能
- [ ] 项目导入导出功能
- [ ] 数据结构版本管理
- [ ] 存储容量监控

#### 2.3 AI功能集成
- [ ] AIModelApplicationSuite集成
- [ ] AI实体生成引擎
- [ ] AI关系建议功能
- [ ] 智能代码生成

### 阶段三：高级功能开发 (2-3周)

#### 3.1 代码生成模块
- [ ] 实体代码自动生成
- [ ] TypeScript类型定义生成
- [ ] API接口代码生成
- [ ] 代码模板管理

#### 3.2 系统管理功能
- [ ] 项目管理界面
- [ ] 系统设置界面
- [ ] 数据备份管理
- [ ] 应用状态监控

## 数据迁移策略

### BDC项目数据迁移
1. **项目配置迁移**
   - 解析BDC项目配置文件
   - 转换为localStorage格式
   - 保持用户自定义配置

2. **实体模型迁移**
   - 提取现有实体定义
   - 转换为新的Entity格式
   - 保留实体关系信息

3. **图谱布局迁移**
   - 保存现有的图谱布局
   - 迁移节点位置和视图状态
   - 保留用户的视觉偏好设置

### 迁移工具开发
```typescript
interface MigrationTool {
  // 项目配置迁移
  migrateProjectConfig(bdcPath: string): Promise<Project>
  
  // 实体模型迁移
  migrateEntityModels(bdcPath: string): Promise<Entity[]>
  
  // 图谱布局迁移
  migrateGraphLayout(bdcPath: string): Promise<GraphLayout>
  
  // 验证迁移结果
  validateMigration(result: MigrationResult): Promise<ValidationReport>
  
  // 保存到localStorage
  saveToStorage(data: AIDatabenchStorage): Promise<void>
}
```

## 依赖项目集成

### 依赖项目集成

### ADB-TypeORM集成
```json
{
  "dependencies": {
    "adb-typeorm": "file:../../ADB-TypeORM",
    "@vitejs/plugin-react": "^4.0.0",
    "react-router-dom": "^6.8.0"
  }
}
```

**集成要点：**
- ✅ 已配置本地包引用路径
- ✅ 集成ADB-TypeORM装饰器和类型定义
- ✅ 实现基于ADB-TypeORM的实体模型管理
- ✅ 配置EntityInfo和ColumnInfo元数据支持
- ✅ 优化Vite的动态导入支持

### 技术变更说明
- **实体设计**：基于ADB-TypeORM的EntityInfo装饰器
- **字段管理**：基于ADB-TypeORM的ColumnInfo装饰器
- **枚举支持**：使用ADB增强枚举（EnumInfo）
- **数据结构**：完全重构以支持ADB-TypeORM元数据

## 开发环境配置

### 本地开发设置
1. **依赖项目集成**
   ```bash
   # 设置网络代理（用户偏好）
   export http_proxy=http://127.0.0.1:7897
   export https_proxy=http://127.0.0.1:7897
   
   # 创建Vite项目
   cd /Users/yanfang/dev/AIDatabench
   yarn create vite frontend --template react-ts
   
   # 集成AIModelApplicationSuite
   cd frontend
   yarn add file:../AIModelApplicationSuite
   
   # 注意：不再集成ADB-TypeORM，因为不使用数据库
   ```

2. **开发服务器配置**
   ```bash
   # 前端开发服务器
   yarn dev
   
   # 后端开发服务器
   yarn dev:backend
   ```

3. **Vite配置优化**
   ```typescript
   // vite.config.ts
   import { defineConfig } from 'vite'
   import react from '@vitejs/plugin-react'
   import path from 'path'
   
   export default defineConfig({
     plugins: [react()],
     resolve: {
       alias: {
         '@': path.resolve(__dirname, './src'),
         'react-ai-model-manager': path.resolve(__dirname, '../AIModelApplicationSuite/dist')
       }
     },
     server: {
       port: 3000,
       proxy: {
         '/api': {
           target: 'http://localhost:3001',
           changeOrigin: true
         }
       }
     }
   })
   ```

## 质量保证计划

### 测试策略
1. **单元测试** - 核心业务逻辑测试
2. **集成测试** - 模块间接口测试
3. **E2E测试** - 关键用户流程测试
4. **性能测试** - 数据库操作和前端性能

### 代码质量
1. **TypeScript严格模式** - 类型安全保障
2. **ESLint + Prettier** - 代码规范统一
3. **Husky Git Hooks** - 提交前质量检查
4. **Code Review** - 代码审查流程

## 部署计划

### 开发环境部署
- Docker容器化配置
- 本地开发环境一键启动
- 热重载和调试支持

### 生产环境准备
- 环境变量管理
- 数据库连接配置
- 性能监控集成
- 日志收集系统

## 风险评估与应对

### 主要风险
1. **数据迁移风险** - 可能导致数据丢失
   - 应对：完整备份 + 分步验证
2. **依赖集成风险** - 本地包可能存在兼容问题
   - 应对：版本锁定 + 集成测试
3. **性能回归风险** - 新架构可能影响性能
   - 应对：性能基准测试 + 持续监控

### 回滚策略
- 保持BDC项目完整性，作为回滚基准
- 实现数据双写机制，确保迁移可逆
- 建立快速回滚流程和应急预案

## 时间规划

| 阶段 | 时间 | 主要任务 | 交付物 |
|------|------|----------|---------|
| 阶段一 | 1.5-2周 | 基础架构搭建 | Vite项目骨架 + 依赖集成 |
| 阶段二 | 3-4周 | 核心功能迁移 | 完整功能模块 |
| 阶段三 | 2-3周 | 高级功能开发 | 增强功能特性 |
| 测试优化 | 1-2周 | 测试和性能优化 | 稳定版本 |
| 部署上线 | 1周 | 生产环境部署 | 正式发布 |

**总预期时间**: 8.5-12周 (约2-3个月)

## 成功标准

### 功能标准
- [ ] BDC核心功能完整迁移（ORM设计、图谱展示）
- [ ] AI功能正常集成和工作
- [ ] localStorage数据持久化稳定可靠
- [ ] 用户界面体验优于原系统
- [ ] 数据导入导出功能完善

### 技术标准
- [ ] 代码测试覆盖率 > 80%
- [ ] 页面加载时间 < 2秒
- [ ] localStorage操作响应时间 < 100ms
- [ ] 系统稳定性 > 99.9%
- [ ] 支持至少100个实体的项目

### 业务标准
- [ ] BDC项目数据无损迁移
- [ ] 功能向后兼容（基础操作）
- [ ] 用户学习成本最小化
- [ ] 开发效率显著提升

---

*此方案将作为AIDatabench项目重构的指导文档，可根据实际开发过程中的反馈进行调整和优化。*