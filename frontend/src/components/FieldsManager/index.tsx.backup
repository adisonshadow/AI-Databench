import React, { useState, useEffect, useMemo } from 'react';
import { 
  Table, 
  Button, 
  Space, 
  Tag, 
  Popconfirm, 
  Typography, 
  Empty,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  InputNumber,
  message,
  Segmented,
  Divider,
  Alert,
  Row,
  Col,
  Tabs,
  Typography as AntdTypography
} from 'antd';
import { 
  PlusOutlined, 
  EditOutlined, 
  DeleteOutlined,
  KeyOutlined,
  CheckCircleOutlined,
  SearchOutlined,
  ExclamationCircleOutlined
} from '@ant-design/icons';
import { StorageService } from '@/stores/storage';
import type { ADBEntity, ADBField, Project, ExtendedColumnInfo } from '@/types/storage';
// import type { EnumItemOptions } from 'adb-typeorm';
import type { ColumnsType } from 'antd/es/table';
import { 
  getFieldTypeConfig, 
  shouldShowConfig, 
  getDefaultValueOptions,
  getFieldTypeHint,
  isIDType,
  requiresLengthConfig,
  requiresPrecisionConfig,
  requiresScaleConfig,
  getTypeORMNativeTypes,
  getADBExtendTypes,
  supportsRelationConfig
} from '@/utils/fieldTypeConfig';
import RelationManager from '../RelationManager';
import ADBEnumManager from '../ADBEnumManager';
import type { 
  Relation, 
  RelationCreateConfig,
  RelationValidationResult,
  RelationConflict
} from '@/types/storage';
import { RelationType, CascadeType } from '@/types/storage';
import { RelationUtils } from '@/utils/relationUtils';




const { Text, Title } = Typography;
const { Option } = Select;

interface FieldsManagerProps {
  entity: ADBEntity;
  project: Project;
  onEntityUpdate: (project: Project) => void;
}


const FieldsManager: React.FC<FieldsManagerProps> = ({ entity, project, onEntityUpdate }) => {
  const [fields, setFields] = useState<ADBField[]>([]);
  const [activeTab, setActiveTab] = useState<'fields' | 'indexes' | 'relations'>('fields'); // æ–°å¢çŠ¶æ€ç”¨äºåˆ‡æ¢è§†å›¾
  const [isModalVisible, setIsModalVisible] = useState(false);
  const [isRelationModalVisible, setIsRelationModalVisible] = useState(false);
  const [isEnumModalVisible, setIsEnumModalVisible] = useState(false);
  const [isEnumSelectModalVisible, setIsEnumSelectModalVisible] = useState(false);
  const [isEntitySelectModalVisible, setIsEntitySelectModalVisible] = useState(false);
  const [selectedEnumCode, setSelectedEnumCode] = useState<string>('');
  const [enumDisplayText, setEnumDisplayText] = useState<string>('');
  const [editingField, setEditingField] = useState<ADBField | null>(null);
  const [formValues, setFormValues] = useState<FieldFormValues>({
    code: '',
    label: '',
    type: '',
    nullable: false,
    unique: false,
    primary: false,
  });
  const [form] = Form.useForm();
  const [isRelationCreateModalVisible, setIsRelationCreateModalVisible] = useState(false);
  const [editingRelationInFields, setEditingRelationInFields] = useState<Relation | null>(null);
  const [relationValidationResult, setRelationValidationResult] = useState<RelationValidationResult | null>(null);
  const [relationConflicts, setRelationConflicts] = useState<RelationConflict[]>([]);
  const [relationForm] = Form.useForm();
  
  // è·å–æ‰€æœ‰æ”¯æŒçš„ç±»å‹
  const typeormNativeTypes = getTypeORMNativeTypes();
  const adbExtendTypes = getADBExtendTypes();

  // è·å–æ‰€æœ‰å®ä½“
  const entities = useMemo(() => {
    return Object.values(project.schema.entities || {});
  }, [project.schema.entities]);

  // è·å–å½“å‰å®ä½“çš„å…³ç³»åˆ—è¡¨
  const entityRelations = useMemo(() => {
    if (!project.schema.relations) return [];
    return project.schema.relations.filter(relation => 
      relation.from.entityId === entity.entityInfo.id || 
      relation.to.entityId === entity.entityInfo.id
    );
  }, [project.schema.relations, entity.entityInfo.id]);

  useEffect(() => {
    const fieldList = Object.values(entity.fields || {});
    setFields(fieldList);
  }, [entity.fields]);



interface FieldFormValues {
  code?: string;
  label?: string;
  type?: string;
  length?: number;
  nullable?: boolean;
  unique?: boolean;
  default?: string;
  primary?: boolean;
  precision?: number;
  scale?: number;
  generated?: boolean | 'increment' | 'uuid' | 'rowid';
  comment?: string;
  status?: 'enabled' | 'disabled' | 'archived';
  orderIndex?: number;
  
  // ADB æ‰©å±•ç±»å‹é…ç½®
  extendType?: string;
  mediaConfig?: {
    mediaType: 'image' | 'video' | 'audio' | 'document' | 'file';
    formats: string[];
    maxSize?: number;
    isMultiple?: boolean;
    storagePath?: string;
  };
  enumConfig?: {
    enum: Record<string, string | number>;
    isMultiple?: boolean;
    default?: string | number;
  };
  autoIncrementIdConfig?: {
    startValue?: number;
    increment?: number;
    sequenceName?: string;
    isPrimaryKey?: boolean;
    description?: string;
  };
  guidIdConfig?: {
    version?: 'v1' | 'v4' | 'v5';
    format?: 'default' | 'braced' | 'binary' | 'urn';
    isPrimaryKey?: boolean;
    description?: string;
    generateOnInsert?: boolean;
  };
  snowflakeIdConfig?: {
    machineId?: number;
    datacenterId?: number;
    epoch?: number;
    isPrimaryKey?: boolean;
    description?: string;
    generateOnInsert?: boolean;
    format?: 'number' | 'string';
  };
}

// å¤„ç†æ–°å»º/ç¼–è¾‘å­—æ®µ
  const handleSaveField = async (values: FieldFormValues) => {
    try {
      const now = new Date().toISOString();
      const fieldId = editingField?.columnInfo.id || `field_${Date.now()}`;
      
      // åˆ¤æ–­æ˜¯å¦ä¸º ADB æ‰©å±•ç±»å‹
      const isADBType = values.type?.startsWith('adb-') || false;
      const extendType = isADBType ? values.type : undefined;
      
      // æ ¹æ®æ‰©å±•ç±»å‹è®¾ç½®å¯¹åº”çš„é…ç½®
      const extendConfig: Partial<ExtendedColumnInfo> = {};
      if (extendType === 'adb-media' && values.mediaConfig) {
        extendConfig.mediaConfig = values.mediaConfig;
      } else if (extendType === 'adb-enum' && values.enumConfig) {
        extendConfig.enumConfig = values.enumConfig;
      } else if (extendType === 'adb-auto-increment-id' && values.autoIncrementIdConfig) {
        extendConfig.autoIncrementIdConfig = values.autoIncrementIdConfig;
      } else if (extendType === 'adb-guid-id' && values.guidIdConfig) {
        extendConfig.guidIdConfig = values.guidIdConfig;
      } else if (extendType === 'adb-snowflake-id' && values.snowflakeIdConfig) {
        extendConfig.snowflakeIdConfig = values.snowflakeIdConfig;
      }

      const newField: ADBField = {
        columnInfo: {
          id: fieldId,
          label: values.label || '',
          code: values.code || '',
          comment: values.code || '', // ä½¿ç”¨codeä½œä¸ºcommentçš„é»˜è®¤å€¼
          status: 'enabled', // é»˜è®¤å¯ç”¨
          orderIndex: 0, // é»˜è®¤æ’åº
          extendType,
          ...extendConfig
        },
        typeormConfig: {
          type: values.type || 'varchar', // ç›´æ¥ä½¿ç”¨é€‰æ‹©çš„ç±»å‹ï¼ŒADB-TypeORM ä¼šå¤„ç†ç±»å‹æ˜ å°„
          length: values.length,
          nullable: values.nullable !== false,
          unique: values.unique || false,
          default: values.default,
          comment: values.code || '', // ä½¿ç”¨codeä½œä¸ºcommentçš„é»˜è®¤å€¼
          primary: values.primary || false,
          precision: values.precision,
          scale: values.scale,
          generated: values.generated
        },
        createdAt: editingField?.createdAt || now,
        updatedAt: now
      };

      // æ›´æ–°å®ä½“
      const updatedEntity = {
        ...entity,
        fields: {
          ...entity.fields,
          [fieldId]: newField
        },
        updatedAt: now
      };

      // æ›´æ–°é¡¹ç›®
      const updatedProject = {
        ...project,
        schema: {
          ...project.schema,
          entities: {
            ...project.schema.entities,
            [entity.entityInfo.id]: updatedEntity
          }
        }
      };

      // ä¿å­˜åˆ°localStorage
      StorageService.saveProject(updatedProject);
      
      // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
      setFields(Object.values(updatedEntity.fields || {}));
      
      // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°
      onEntityUpdate(updatedProject);

      setIsModalVisible(false);
      setEditingField(null);
      
      message.success(`å­—æ®µ${editingField ? 'æ›´æ–°' : 'åˆ›å»º'}æˆåŠŸ`);
    } catch (error) {
      console.error('ä¿å­˜å­—æ®µå¤±è´¥:', error);
      message.error('ä¿å­˜å­—æ®µå¤±è´¥');
    }
  };

  // å¤„ç†åˆ é™¤å­—æ®µ
  const handleDeleteField = async (field: ADBField) => {
    try {
      const now = new Date().toISOString();
      // eslint-disable-next-line @typescript-eslint/no-unused-vars
      const { [field.columnInfo.id]: _, ...remainingFields } = entity.fields;
      
      const updatedEntity = {
        ...entity,
        fields: remainingFields,
        updatedAt: now
      };

      const updatedProject = {
        ...project,
        schema: {
          ...project.schema,
          entities: {
            ...project.schema.entities,
            [entity.entityInfo.id]: updatedEntity
          }
        }
      };

      StorageService.saveProject(updatedProject);
      
      // ç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€
      setFields(Object.values(updatedEntity.fields || {}));
      
      // é€šçŸ¥çˆ¶ç»„ä»¶æ›´æ–°
      onEntityUpdate(updatedProject);
      
      message.success('å­—æ®µåˆ é™¤æˆåŠŸ');
    } catch (error) {
      console.error('åˆ é™¤å­—æ®µå¤±è´¥:', error);
      message.error('åˆ é™¤å­—æ®µå¤±è´¥');
    }
  };

  // å¤„ç†ç¼–è¾‘å…³ç³»
  const handleEditRelation = (relation: Relation) => {
    // è®¾ç½®æ­£åœ¨ç¼–è¾‘çš„å…³ç³»
    setEditingRelationInFields(relation);
    // æ‰“å¼€å…³ç³»åˆ›å»ºæ¨¡æ€æ¡†
    setIsRelationCreateModalVisible(true);
  };

  // å¤„ç†æ–°å»ºå…³ç³»
  const handleCreateRelation = () => {
    setEditingRelationInFields(null);
    setIsRelationCreateModalVisible(true);
  };

  // å¤„ç†åˆ é™¤å…³ç³»
  const handleDeleteRelation = (relationId: string) => {
    const updatedRelations = project.schema.relations?.filter(r => r.id !== relationId) || [];
    const updatedProject = {
      ...project,
      schema: {
        ...project.schema,
        relations: updatedRelations,
      },
    };
    StorageService.saveProject(updatedProject);
    onEntityUpdate(updatedProject);
    message.success('å…³ç³»åˆ é™¤æˆåŠŸ');
  };

  // å¤„ç†ç¼–è¾‘å­—æ®µ
  const handleEditField = (field: ADBField) => {
    setEditingField(field);
    
    // è®¾ç½®æšä¸¾é€‰æ‹©çŠ¶æ€
    if (field.columnInfo.enumConfig?.enum) {
      const selectedEnum = Object.values(project.schema.enums || {}).find(e => e.enumInfo.code === field.columnInfo.enumConfig?.enum);
      if (selectedEnum) {
        setSelectedEnumCode(selectedEnum.enumInfo.code);
        setEnumDisplayText(`${selectedEnum.enumInfo.code}ï¼ˆ${selectedEnum.enumInfo.description || selectedEnum.enumInfo.label}ï¼‰`);
      }
    } else {
      setSelectedEnumCode('');
      setEnumDisplayText('');
    }
    
    setIsModalVisible(true);
  };

  // å¤„ç†æ–°å»ºå­—æ®µ
  const handleCreateField = () => {
    setEditingField(null);
    form.resetFields();
    setFormValues({
      code: '',
      label: '',
      type: '',
      nullable: false,
      unique: false,
      primary: false,
    });
    setSelectedEnumCode('');
    setEnumDisplayText('');
    setIsModalVisible(true);
  };

  // å¤„ç†æšä¸¾é€‰æ‹©
  const handleEnumSelect = (enumCode: string) => {
    const selectedEnum = Object.values(project.schema.enums || {}).find(e => e.enumInfo.code === enumCode);
    if (selectedEnum) {
      setSelectedEnumCode(enumCode);
      setEnumDisplayText(`${selectedEnum.enumInfo.code}ï¼ˆ${selectedEnum.enumInfo.description || selectedEnum.enumInfo.label}ï¼‰`);
      form.setFieldValue('enumConfig', {
        ...form.getFieldValue('enumConfig'),
        enum: enumCode
      });
    }
  };

  // å¤„ç†æšä¸¾æ¸…ç©º
  const handleEnumClear = () => {
    setSelectedEnumCode('');
    setEnumDisplayText('');
    form.setFieldValue('enumConfig', {
      ...form.getFieldValue('enumConfig'),
      enum: ''
    });
  };

  // è·å–å½“å‰é€‰ä¸­çš„æšä¸¾é€‰é¡¹
  const getCurrentEnumOptions = () => {
    if (!selectedEnumCode) return [];
    const selectedEnum = Object.values(project.schema.enums || {}).find(e => e.enumInfo.code === selectedEnumCode);
    if (!selectedEnum) return [];
    
    // å°†EnumInfoOptionsçš„itemsè½¬æ¢ä¸ºé€‰é¡¹æ•°ç»„
    return Object.entries(selectedEnum.enumInfo.items || {}).map(([value, item]) => ({
      value,
      label: (item as { label: string }).label
    }));
  };

  // è·å–å®ä½“çš„å­—æ®µé€‰é¡¹
  const getFieldOptionsForEntity = (entityId: string) => {
    if (!entityId) return [];
    const entity = project.schema.entities[entityId];
    if (!entity) return [];
    
    // è¿”å›å®ä½“çš„æ‰€æœ‰å­—æ®µä½œä¸ºé€‰é¡¹
    return Object.values(entity.fields || {}).map(field => ({
      value: field.columnInfo.id,
      label: `${field.columnInfo.label} (${field.columnInfo.code})`
    }));
  };

  // æšä¸¾é€‰æ‹©æ¨¡æ€æ¡†ç»„ä»¶
  interface EnumSelectModalProps {
    visible: boolean;
    onCancel: () => void;
    onConfirm: (enumCode: string) => void;
    project: Project;
    selectedEnumCode: string;
  }

  const EnumSelectModal: React.FC<EnumSelectModalProps> = ({
    visible,
    onCancel,
    onConfirm,
    project,
    selectedEnumCode
  }) => {
    const [tempSelectedEnumCode, setTempSelectedEnumCode] = useState<string>(selectedEnumCode);
    const [searchText, setSearchText] = useState('');
    const [viewMode, setViewMode] = useState<'list' | 'tree'>('list');

    // è·å–æ‰€æœ‰å¯ç”¨çš„æšä¸¾
    const enabledEnums = useMemo(() => {
      return Object.values(project.schema.enums || {}).filter(() => {
        // è¿™é‡Œå‡è®¾æ‰€æœ‰æšä¸¾éƒ½æ˜¯å¯ç”¨çŠ¶æ€ï¼Œå› ä¸ºADBEnumDefinitionæ²¡æœ‰statuså­—æ®µ
        return true;
      });
    }, [project.schema.enums]);

    // è¿‡æ»¤æšä¸¾åˆ—è¡¨
    const filteredEnums = useMemo(() => enabledEnums.filter(enumItem =>
      enumItem.enumInfo.code.toLowerCase().includes(searchText.toLowerCase()) ||
      enumItem.enumInfo.label.toLowerCase().includes(searchText.toLowerCase()) ||
      enumItem.enumInfo.description?.toLowerCase().includes(searchText.toLowerCase())
    ), [enabledEnums, searchText]);

    // æ„å»ºæ ‘å½¢æ•°æ®
    const treeData = useMemo(() => {
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const codeMap = new Map<string, any>();
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      const result: any[] = [];
      const allCodes: string[] = [];

      filteredEnums.forEach(enumItem => {
        const codes = enumItem.enumInfo.code.split(':');
        let currentPath = '';
        
        codes.forEach((code: string, index: number) => {
          const parentPath = currentPath;
          currentPath = currentPath ? `${currentPath}:${code}` : code;
          allCodes.push(currentPath);
          
          if (!codeMap.has(currentPath)) {
            const node = {
              value: currentPath,
              label: index === codes.length - 1 ? enumItem.enumInfo.label : code,
              // eslint-disable-next-line @typescript-eslint/no-explicit-any
              children: [] as any[],
              parentPath: parentPath || undefined,
              enumInfo: index === codes.length - 1 ? enumItem.enumInfo : undefined,
              createdAt: index === codes.length - 1 ? enumItem.createdAt : undefined,
              updatedAt: index === codes.length - 1 ? enumItem.updatedAt : undefined
            };
            codeMap.set(currentPath, node);
          }
        });
      });

      // æ„å»ºæ ‘å½¢ç»“æ„
      codeMap.forEach((node) => {
        if (node.parentPath) {
          const parent = codeMap.get(node.parentPath);
          if (parent) {
            parent.children = parent.children || [];
            parent.children.push(node);
          }
        }
      });

      // åªè¿”å›æ ¹èŠ‚ç‚¹
      const rootNodes = Array.from(codeMap.values()).filter(node => !node.parentPath);
      
      // é€’å½’å¤„ç†èŠ‚ç‚¹
      const processNode = (node: any): any => {
        if (node.children && node.children.length > 0) {
          node.children = node.children.map(processNode);
        }
        return node;
      };

      return rootNodes.map(processNode);
    }, [filteredEnums]);

    // è¡¨æ ¼åˆ—å®šä¹‰
    const columns = useMemo(() => [
      {
        title: 'ä»£ç ',
        dataIndex: 'enumInfo.code',
        key: 'code',
        width: viewMode === 'tree' ? 200 : undefined,
        ellipsis: true,
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        render: (text: string, record: any) => {
          if (viewMode === 'tree' && record.children && record.children.length > 0) {
            return null;
          }
          return <Tag color="blue">{record.enumInfo?.code || record.value}</Tag>;
        }
      },
      {
        title: 'æ˜¾ç¤ºåç§°',
        dataIndex: 'enumInfo.label',
        key: 'label',
        width: viewMode === 'tree' ? 200 : undefined,
        ellipsis: true,
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        render: (text: string, record: any) => {
          if (viewMode === 'tree' && record.children && record.children.length > 0) {
            return null;
          }
          const label = viewMode === 'tree' ? (record.enumInfo?.label || text) : (record.enumInfo?.label || text);
          return label;
        }
      },
      {
        title: 'æè¿°',
        dataIndex: 'enumInfo.description',
        key: 'description',
        width: viewMode === 'tree' ? 200 : undefined,
        ellipsis: true,
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        render: (text: string, record: any) => {
          if (viewMode === 'tree' && record.children && record.children.length > 0) {
            return null;
          }
          const description = viewMode === 'tree' ? (record.enumInfo?.description || text) : (record.enumInfo?.description || text);
          return description || '-';
        }
      },
      {
        title: 'é€‰é¡¹æ•°é‡',
        key: 'optionsCount',
        width: 80,
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        render: (record: any) => {
          if (viewMode === 'tree' && record.children && record.children.length > 0) {
            return null;
          }
          const enumData = viewMode === 'tree' ? record : record;
          const options = Object.entries(enumData.enumInfo?.items || {});
          return <Tag color="green">{options.length}</Tag>;
        }
      }
    ], [viewMode]);

    // å¤„ç†æšä¸¾é€‰æ‹©
    const handleEnumClick = (enumCode: string) => {
      setTempSelectedEnumCode(enumCode);
    };

    // å¤„ç†ç¡®è®¤é€‰æ‹©
    const handleConfirm = () => {
      if (tempSelectedEnumCode) {
        onConfirm(tempSelectedEnumCode);
      }
    };

    // é‡ç½®ä¸´æ—¶é€‰æ‹©çŠ¶æ€
    useEffect(() => {
      if (visible) {
        setTempSelectedEnumCode(selectedEnumCode);
      }
    }, [visible, selectedEnumCode]);

    return (
      <Modal
        title="é€‰æ‹©æšä¸¾"
        open={visible}
        onCancel={onCancel}
        onOk={handleConfirm}
        width={800}
        okText="ç¡®è®¤é€‰æ‹©"
        cancelText="å–æ¶ˆ"
        okButtonProps={{ disabled: !tempSelectedEnumCode }}
        destroyOnHidden
      >
        {/* æœç´¢å’Œè§†å›¾åˆ‡æ¢ */}
        <div style={{ marginBottom: 16 }}>
          <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
            <Space>
              <Segmented
                options={[
                  { label: 'åˆ—è¡¨', value: 'list' },
                  { label: 'æ ‘å½¢', value: 'tree' }
                ]}
                value={viewMode}
                onChange={(value) => setViewMode(value as 'list' | 'tree')}
              />
              <Input
                placeholder="æœç´¢æšä¸¾ä»£ç ã€åç§°æˆ–æè¿°"
                prefix={<SearchOutlined />}
                value={searchText}
                onChange={(e) => setSearchText(e.target.value)}
                style={{ width: 300 }}
              />
            </Space>
          </div>
        </div>

        {/* è¡¨æ ¼åŒºåŸŸ */}
        <div style={{ height: 400, overflow: 'auto' }}>
          <Table
            columns={columns}
            dataSource={viewMode === 'list' ? filteredEnums : treeData}
            pagination={false}
            rowKey={viewMode === 'list' ? "id" : "value"}
            size="small"
            onRow={(record) => ({
              onClick: () => {
                const enumCode = viewMode === 'tree' ? record.enumInfo?.code : record.enumInfo?.code;
                if (enumCode) {
                  handleEnumClick(enumCode);
                }
              },
              style: {
                cursor: 'pointer',
                backgroundColor: tempSelectedEnumCode === (viewMode === 'tree' ? record.enumInfo?.code : record.enumInfo?.code) 
                  ? 'rgba(139, 69, 255, 0.1)' : undefined, // åŠé€æ˜ç´«è‰²èƒŒæ™¯
              }
            })}
            expandable={viewMode === 'tree' ? {
              childrenColumnName: "children",
              indentSize: 20
            } : undefined}
          />
        </div>
      </Modal>
    );
  };

  // å®ä½“é€‰æ‹©æ¨¡æ€æ¡†ç»„ä»¶
  interface EntitySelectModalProps {
    visible: boolean;
    onCancel: () => void;
    onConfirm: (entityId: string, entityName: string) => void;
    project: Project;
  }

  const EntitySelectModal: React.FC<EntitySelectModalProps> = ({
    visible,
    onCancel,
    onConfirm,
    project
  }) => {
    const [tempSelectedEntityId, setTempSelectedEntityId] = useState<string>('');
    const [tempSelectedEntityName, setTempSelectedEntityName] = useState<string>('');
    const [searchText, setSearchText] = useState('');

    // è·å–æ‰€æœ‰å®ä½“
    const allEntities = useMemo(() => {
      return Object.values(project.schema.entities || {});
    }, [project.schema.entities]);

    // è¿‡æ»¤å®ä½“åˆ—è¡¨
    const filteredEntities = useMemo(() => allEntities.filter(entity =>
      entity.entityInfo.code.toLowerCase().includes(searchText.toLowerCase()) ||
      entity.entityInfo.label.toLowerCase().includes(searchText.toLowerCase()) ||
      entity.entityInfo.description?.toLowerCase().includes(searchText.toLowerCase())
    ), [allEntities, searchText]);

    // å¤„ç†å®ä½“é€‰æ‹©
    const handleEntityClick = (entity: ADBEntity) => {
      setTempSelectedEntityId(entity.entityInfo.id);
      setTempSelectedEntityName(entity.entityInfo.label || entity.entityInfo.code);
    };

    // å¤„ç†ç¡®è®¤é€‰æ‹©
    const handleConfirm = () => {
      if (tempSelectedEntityId) {
        onConfirm(tempSelectedEntityId, tempSelectedEntityName);
      }
    };

    return (
      <Modal
        title="é€‰æ‹©ç›®æ ‡å®ä½“"
        open={visible}
        onCancel={onCancel}
        onOk={handleConfirm}
        width={800}
        okText="ç¡®è®¤é€‰æ‹©"
        cancelText="å–æ¶ˆ"
        okButtonProps={{ disabled: !tempSelectedEntityId }}
        destroyOnHidden
      >
        {/* æœç´¢æ¡† */}
        <div style={{ marginBottom: 16 }}>
          <Input
            placeholder="æœç´¢å®ä½“ä»£ç ã€åç§°æˆ–æè¿°"
            prefix={<SearchOutlined />}
            value={searchText}
            onChange={(e) => setSearchText(e.target.value)}
            style={{ width: '100%' }}
          />
        </div>

        {/* å®ä½“åˆ—è¡¨ */}
        <div style={{ height: 400, overflow: 'auto' }}>
          <Table
            columns={[
              {
                title: 'ä»£ç ',
                dataIndex: ['entityInfo', 'code'],
                key: 'code',
              },
              {
                title: 'æ˜¾ç¤ºåç§°',
                dataIndex: ['entityInfo', 'label'],
                key: 'label',
              },
              {
                title: 'æè¿°',
                dataIndex: ['entityInfo', 'description'],
                key: 'description',
                ellipsis: true,
                render: (text: string) => text || '-',
              }
            ]}
            dataSource={filteredEntities}
            pagination={false}
            rowKey={(record) => record.entityInfo.id}
            size="small"
            onRow={(record) => ({
              onClick: () => handleEntityClick(record),
              style: {
                cursor: 'pointer',
                backgroundColor: tempSelectedEntityId === record.entityInfo.id 
                  ? 'rgba(139, 69, 255, 0.1)' : undefined, // åŠé€æ˜ç´«è‰²èƒŒæ™¯
              }
            })}
          />
        </div>
      </Modal>
    );
  };

  // å…³ç³»è¡¨æ ¼åˆ—å®šä¹‰
  const relationColumns: ColumnsType<Relation> = [
    {
      title: 'å…³ç³»ç±»å‹',
      dataIndex: 'type',
      key: 'type',
      width: 100,
      render: (type: RelationType) => (
        <Tag color={getRelationTypeColor(type)}>
          {RelationUtils.getRelationTypeDisplayName(type)}
        </Tag>
      ),
    },
    {
      title: 'æºå®ä½“',
      dataIndex: ['from', 'entityName'],
      key: 'from',
      width: 120,
    },
    {
      title: 'ç›®æ ‡å®ä½“',
      dataIndex: ['to', 'entityName'],
      key: 'to',
      width: 120,
    },
    {
      title: 'å…³ç³»åç§°',
      dataIndex: 'name',
      key: 'name',
      width: 120,
    },
    {
      title: 'åå‘åç§°',
      dataIndex: 'inverseName',
      key: 'inverseName',
      width: 120,
      render: (inverseName: string) => inverseName || '-',
    },
    {
      title: 'çº§è”æ“ä½œ',
      dataIndex: ['config', 'cascade'],
      key: 'cascade',
      width: 80,
      render: (cascade: boolean) => (
        <Tag color={cascade ? 'green' : 'default'}>
          {cascade ? 'æ˜¯' : 'å¦'}
        </Tag>
      ),
    },
    {
      title: 'åˆ é™¤ç­–ç•¥',
      dataIndex: ['config', 'onDelete'],
      key: 'onDelete',
      width: 100,
      render: (onDelete: CascadeType) => (
        <Tag color={getCascadeTypeColor(onDelete)}>
          {RelationUtils.getCascadeTypeDisplayName(onDelete)}
        </Tag>
      ),
    },
    {
      title: 'æ“ä½œ',
      key: 'actions',
      width: 120,
      render: (_, record) => (
        <Space size="small">
          <Button
            type="link"
            icon={<EditOutlined />}
            size="small"
            onClick={() => handleEditRelation(record)}
          />
          <Popconfirm
            title="ç¡®å®šåˆ é™¤æ­¤å…³ç³»ï¼Ÿ"
            description="åˆ é™¤å…³ç³»å¯èƒ½ä¼šå½±å“æ•°æ®å®Œæ•´æ€§ï¼Œè¯·è°¨æ…æ“ä½œã€‚"
            icon={<ExclamationCircleOutlined style={{ color: 'red' }} />}
            onConfirm={() => handleDeleteRelation(record.id)}
            okText="ç¡®å®š"
            cancelText="å–æ¶ˆ"
          >
            <Button
              type="link"
              icon={<DeleteOutlined />}
              size="small"
              danger
            />
          </Popconfirm>
        </Space>
      ),
    },
  ];

  // è·å–å…³ç³»ç±»å‹é¢œè‰²
  const getRelationTypeColor = (type: RelationType): string => {
    const colors = {
      [RelationType.ONE_TO_ONE]: 'blue',
      [RelationType.ONE_TO_MANY]: 'green',
      [RelationType.MANY_TO_ONE]: 'orange',
      [RelationType.MANY_TO_MANY]: 'purple',
    };
    return colors[type];
  };

  // è·å–çº§è”ç±»å‹é¢œè‰²
  const getCascadeTypeColor = (type: CascadeType): string => {
    const colors = {
      [CascadeType.CASCADE]: 'red',
      [CascadeType.SET_NULL]: 'orange',
      [CascadeType.RESTRICT]: 'blue',
      [CascadeType.NO_ACTION]: 'default',
    };
    return colors[type];
  };

  // è¡¨æ ¼åˆ—å®šä¹‰
  const columns: ColumnsType<ADBField> = [
    {
      title: 'å­—æ®µæ ‡è¯†',
      dataIndex: ['columnInfo', 'code'],
      key: 'code',
      width: 120,
      render: (code: string, record: ADBField) => (
        <div>
          <code style={{ color: '#1890ff' }}>{code}</code>
          {record.typeormConfig.primary && (
            <KeyOutlined style={{ color: '#f39c12', marginLeft: 4 }} title="ä¸»é”®" />
          )}
          {record.typeormConfig.unique && (
            <CheckCircleOutlined style={{ color: '#52c41a', marginLeft: 4 }} title="å”¯ä¸€" />
          )}
        </div>
      )
    },
    {
      title: 'æ˜¾ç¤ºåç§°',
      dataIndex: ['columnInfo', 'label'],
      key: 'label',
      width: 120
    },
    {
      title: 'æ•°æ®ç±»å‹',
      key: 'type',
      width: 120,
      render: (_, record: ADBField) => {
        const { type, length, precision, scale } = record.typeormConfig;
        const { extendType } = record.columnInfo;
        
        // å¦‚æœæœ‰æ‰©å±•ç±»å‹ï¼Œä¼˜å…ˆæ˜¾ç¤ºæ‰©å±•ç±»å‹
        const displayType = extendType || type;
        let typeDisplay = displayType;
        
        if (length) {
          typeDisplay += `(${length})`;
        } else if (precision !== undefined && scale !== undefined) {
          typeDisplay += `(${precision},${scale})`;
        } else if (precision !== undefined) {
          typeDisplay += `(${precision})`;
        }
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„é¢œè‰²
        const getTagColor = (type: string): string => {
          if (type.startsWith('adb-')) {
            return 'purple'; // ADB æ‰©å±•ç±»å‹ä½¿ç”¨ç´«è‰²
          }
          return 'blue'; // TypeORM åŸç”Ÿç±»å‹ä½¿ç”¨è“è‰²
        };
        
        return <Tag color={getTagColor(displayType)}>{typeDisplay.toUpperCase()}</Tag>;
      }
    },
    {
      title: 'çº¦æŸ',
      key: 'constraints',
      width: 100,
      render: (_, record: ADBField) => (
        <Space size={4}>
          {!record.typeormConfig.nullable && <Tag color="red">NOT NULL</Tag>}
          {record.typeormConfig.unique && <Tag color="green">UNIQUE</Tag>}
          {record.typeormConfig.default !== undefined && (
            <Tag color="orange">DEFAULT</Tag>
          )}
        </Space>
      )
    },
    {
      title: 'é»˜è®¤å€¼',
      dataIndex: ['typeormConfig', 'default'],
      key: 'default',
      width: 100,
      render: (defaultValue: string | number | boolean | undefined) => (
        defaultValue !== undefined ? <code>{String(defaultValue)}</code> : <Text type="secondary">-</Text>
      )
    },
    // {
    //   title: 'çŠ¶æ€',
    //   dataIndex: ['columnInfo', 'status'],
    //   key: 'status',
    //   width: 80,
    //   render: (status: string) => {
    //     const colors = { enabled: 'green', disabled: 'orange', archived: 'red' };
    //     const labels = { enabled: 'å¯ç”¨', disabled: 'ç¦ç”¨', archived: 'å½’æ¡£' };
    //     return (
    //       <Tag color={colors[status as keyof typeof colors]}>
    //         {labels[status as keyof typeof labels]}
    //       </Tag>
    //     );
    //   }
    // },
    // {
    //   title: 'è¯´æ˜',
    //   dataIndex: ['columnInfo', 'comment'],
    //   key: 'comment',
    //   ellipsis: true,
    //   render: (comment: string) => comment || <Text type="secondary">-</Text>
    // },
    {
      title: 'æ“ä½œ',
      key: 'actions',
      width: 100,
      fixed: 'right',
      render: (_, record: ADBField) => (
        <Space size="small">
          <Button 
            type="text" 
            icon={<EditOutlined />} 
            size="small"
            onClick={() => handleEditField(record)}
          />
          <Popconfirm
            title="ç¡®å®šåˆ é™¤æ­¤å­—æ®µï¼Ÿ"
            description="åˆ é™¤åå°†æ— æ³•æ¢å¤ï¼Œç›¸å…³å…³ç³»ä¹Ÿä¼šè¢«æ¸…é™¤"
            onConfirm={() => handleDeleteField(record)}
            okText="åˆ é™¤"
            cancelText="å–æ¶ˆ"
            okButtonProps={{ danger: true }}
          >
            <Button 
              type="text" 
              icon={<DeleteOutlined />} 
              size="small"
              danger
            />
          </Popconfirm>
        </Space>
      )
    }
  ];

  return (
    <div style={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      {/* å­—æ®µç®¡ç†å¤´éƒ¨ */}
      <Space style={{ 
        height: 40,
        padding: '0 20px',
        display: 'flex',
        justifyContent: 'space-between',
        alignItems: 'center'
      }}>
        <div>
          {/* ä½¿ç”¨Segmentedç»„ä»¶æ›¿æ¢åŸæ¥çš„è¡¨åæ˜¾ç¤º */}
          <Segmented
            options={[
              { label: 'å­—æ®µ', value: 'fields' },
              { label: 'ç´¢å¼•', value: 'indexes' },
              { label: 'å…³ç³»', value: 'relations' }
            ]}
            value={activeTab}
            onChange={(value) => setActiveTab(value as 'fields' | 'indexes' | 'relations')}
          />
        </div>
        <Space>
          {/* æ ¹æ®å½“å‰æ´»åŠ¨çš„tabæ˜¾ç¤ºä¸åŒçš„æŒ‰é’® */}
          {activeTab === 'fields' && (
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              onClick={handleCreateField}
            >
              æ–°å»ºå­—æ®µ
            </Button>
          )}
          {activeTab === 'relations' && (
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              onClick={handleCreateRelation}
            >
              æ–°å»ºå…³ç³»
            </Button>
          )}
          {activeTab === 'indexes' && (
            <Button 
              type="primary" 
              icon={<PlusOutlined />}
              // onClick={handleCreateIndex} // TODO: éœ€è¦å®ç°ç´¢å¼•åˆ›å»ºåŠŸèƒ½
            >
              æ–°å»ºç´¢å¼•
            </Button>
          )}
        </Space>
      </Space>
      
      {/* å­—æ®µåˆ—è¡¨å†…å®¹åŒºåŸŸ */}
      <div style={{ 
        flex: 1, 
        overflow: 'auto', 
        padding: '16px',
        backgroundColor: '#141414'
      }}>
        {/* æ ¹æ®å½“å‰æ´»åŠ¨çš„tabæ˜¾ç¤ºä¸åŒçš„å†…å®¹ */}
        {activeTab === 'fields' && (
          <>
            {/* å­—æ®µåˆ—è¡¨è¡¨æ ¼ */}
            {fields.length > 0 ? (
              <Table
                columns={columns}
                dataSource={fields}
                rowKey={(record) => record.columnInfo.id}
                size="small"
                scroll={{ x: 800 }}
                pagination={false}
              />
            ) : (
              <Empty 
                description="æš‚æ— å­—æ®µï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ–°å»ºå­—æ®µ"
                style={{ margin: '40px 0' }}
              />
            )}
          </>
        )}
        
        {activeTab === 'relations' && (
          <div>
            {entityRelations.length > 0 ? (
              <Table
                columns={relationColumns}
                dataSource={entityRelations}
                rowKey="id"
                size="small"
                scroll={{ x: 1000 }}
                pagination={false}
              />
            ) : (
              <Empty 
                description="æš‚æ— å…³ç³»ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ–°å»ºå…³ç³»"
                style={{ margin: '40px 0' }}
              />
            )}
          </div>
        )}
        
        {activeTab === 'indexes' && (
          <div>
            <Empty 
              description="ç´¢å¼•ç®¡ç†åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­"
              style={{ margin: '40px 0' }}
            />
          </div>
        )}
      </div>

      {/* å­—æ®µç¼–è¾‘æ¨¡æ€æ¡† */}
      <Modal
        title={editingField ? 'ç¼–è¾‘å­—æ®µ' : 'æ–°å»ºå­—æ®µ'}
        open={isModalVisible}
        onCancel={() => {
          setIsModalVisible(false);
          setEditingField(null);
          setFormValues({
            code: '',
            label: '',
            type: '',
            nullable: false,
            unique: false,
            primary: false,
          });
        }}
        onOk={() => form.submit()}
        width={600}
        forceRender  // å¼ºåˆ¶æ¸²æŸ“Modalå†…å®¹ï¼Œç¡®ä¿Formåˆå§‹åŒ–
        afterOpenChange={(open) => {
          // å½“Modalæ‰“å¼€åï¼Œç¡®ä¿è¡¨å•æ•°æ®æ­£ç¡®è®¾ç½®
          if (open && editingField) {
            const fieldValues = {
              code: editingField.columnInfo.code,
              label: editingField.columnInfo.label,
              comment: editingField.columnInfo.comment,
              status: editingField.columnInfo.status,
              orderIndex: editingField.columnInfo.orderIndex,
              type: editingField.columnInfo.extendType || editingField.typeormConfig.type,
              length: editingField.typeormConfig.length,
              nullable: editingField.typeormConfig.nullable,
              unique: editingField.typeormConfig.unique,
              default: editingField.typeormConfig.default,
              primary: editingField.typeormConfig.primary,
              precision: editingField.typeormConfig.precision,
              scale: editingField.typeormConfig.scale,
              generated: editingField.typeormConfig.generated,
              // æ‰©å±•ç±»å‹é…ç½®
              extendType: editingField.columnInfo.extendType,
              mediaConfig: editingField.columnInfo.mediaConfig,
              enumConfig: editingField.columnInfo.enumConfig,
              autoIncrementIdConfig: editingField.columnInfo.autoIncrementIdConfig,
              guidIdConfig: editingField.columnInfo.guidIdConfig,
              snowflakeIdConfig: editingField.columnInfo.snowflakeIdConfig
            };
            form.setFieldsValue(fieldValues);
            setFormValues(fieldValues);
          } else if (open && !editingField) {
            // æ–°å»ºå­—æ®µæ—¶é‡ç½®è¡¨å•
            form.resetFields();
            setFormValues({
              code: '',
              label: '',
              type: '',
              nullable: false,
              unique: false,
              primary: false,
            });
          }
        }}
        maskClosable={false}
        destroyOnHidden={false}  // ä¿æŒModalå†…å®¹ï¼Œç¡®ä¿Formå®ä¾‹è¿æ¥
      >
        <Form
          form={form}
          onFinish={handleSaveField}
          onValuesChange={(_, allValues) => {
            // æ›´æ–°è¡¨å•å€¼ï¼Œä½†ä¿æŠ¤ type å­—æ®µä¸è¢«æ„å¤–æ¸…ç©º
            setFormValues(prev => {
              const newValues = { ...prev, ...allValues };
              // å¦‚æœ type å­—æ®µåœ¨è¡¨å•ä¸­å­˜åœ¨ä¸”ä¸ä¸ºç©ºï¼Œä¿æŒå®ƒ
              if (allValues.type && allValues.type !== '') {
                newValues.type = allValues.type;
              } else if (prev.type && prev.type !== '') {
                // å¦‚æœè¡¨å•ä¸­çš„ type ä¸ºç©ºä½†ä¹‹å‰æœ‰å€¼ï¼Œä¿æŒä¹‹å‰çš„å€¼
                newValues.type = prev.type;
              }
              return newValues;
            });
          }}
          labelCol={{ span: 7 }}
          wrapperCol={{ span: 15 }}
          // labelWrap
          layout="horizontal"
          preserve={false}
          style={{ paddingTop: 30 }}
        >
          <Form.Item
            name="code"
            label="å­—æ®µæ ‡è¯†"
            hasFeedback
            rules={[
              { required: true, message: 'è¯·è¾“å…¥å­—æ®µæ ‡è¯†' },
              { pattern: /^[a-zA-Z][a-zA-Z0-9_]*$/, message: 'å­—æ®µæ ‡è¯†åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œä¸”ä»¥å­—æ¯å¼€å¤´' }
            ]}
          >
            <Input placeholder="ä¾‹å¦‚: user_name" />
          </Form.Item>

          <Form.Item
            name="label"
            label="æ˜¾ç¤ºåç§°"
            rules={[{ required: true, message: 'è¯·è¾“å…¥æ˜¾ç¤ºåç§°' }]}
          >
            <Input placeholder="ä¾‹å¦‚: ç”¨æˆ·å§“å" />
          </Form.Item>

          <Form.Item
            name="type"
            label="æ•°æ®ç±»å‹"
            rules={[{ required: true, message: 'è¯·é€‰æ‹©æ•°æ®ç±»å‹' }]}
          >
            <Select 
              placeholder="é€‰æ‹©æ•°æ®ç±»å‹"
              onChange={(value) => {
                // å½“ç±»å‹æ”¹å˜æ—¶ï¼Œé‡ç½®ç›¸å…³å­—æ®µ
                const config = getFieldTypeConfig(value);
                
                // é‡ç½®ä¸é€‚ç”¨çš„å­—æ®µ
                const resetFields: Record<string, unknown> = {};
                if (!config.length) resetFields.length = undefined;
                if (!config.precision) resetFields.precision = undefined;
                if (!config.scale) resetFields.scale = undefined;
                if (!config.default) resetFields.default = undefined;
                if (!config.unique) resetFields.unique = false;
                if (!config.primary) resetFields.primary = false;
                
                // IDç±»å‹ç‰¹æ®Šå¤„ç†
                if (isIDType(value)) {
                  resetFields.nullable = false;
                  resetFields.unique = false;
                  resetFields.primary = false;
                  resetFields.default = undefined;
                }
                
                form.setFieldsValue(resetFields);
              }}
            >
              <Select.OptGroup label="TypeORM åŸç”Ÿç±»å‹">
                {typeormNativeTypes.map(type => (
                  <Option key={type.type} value={type.type}>
                    {type.label}
                  </Option>
                ))}
              </Select.OptGroup>
              <Select.OptGroup label="ADB æ‰©å±•ç±»å‹">
                {adbExtendTypes.map(type => (
                  <Option key={type.type} value={type.type}>
                    {type.label}
                  </Option>
                ))}
              </Select.OptGroup>
            </Select>
          </Form.Item>

          {/* æ™ºèƒ½æç¤º */}
          {formValues.type && getFieldTypeHint(formValues.type) && (
            <div style={{ 
              marginBottom: 16, 
              padding: '8px 12px', 
              backgroundColor: '#f6ffed22', 
              border: '1px solid #b7eb8f33', 
              borderRadius: 6,
              textAlign: 'center',
              fontSize: '12px',
              color: '#52c41a'
            }}>
              ğŸ’¡ {getFieldTypeHint(formValues.type)}
            </div>
          )}

          {/* é•¿åº¦å’Œç²¾åº¦é…ç½® - ä½¿ç”¨æ¡ä»¶æ¸²æŸ“ï¼Œé¿å…ç©ºç™½ Form.Item */}
          {formValues.type && requiresLengthConfig(formValues.type) && (
            <Form.Item
              name="length"
              label="é•¿åº¦"
              rules={[{ required: true, message: 'è¯·è¾“å…¥é•¿åº¦' }]}
            >
              <InputNumber min={1} max={65535} placeholder="å­—ç¬¦é•¿åº¦" style={{ width: '100%' }} />
            </Form.Item>
          )}
          
          {formValues.type && requiresPrecisionConfig(formValues.type) && (
            <div style={{ display: 'flex', gap: 16 }}>
              <Form.Item
                name="precision"
                label="ç²¾åº¦"
                style={{ flex: 1 }}
                rules={[{ required: true, message: 'è¯·è¾“å…¥ç²¾åº¦' }]}
              >
                <InputNumber min={1} max={65} placeholder="æ€»ä½æ•°" style={{ width: '100%' }} />
              </Form.Item>
              {requiresScaleConfig(formValues.type) && (
                <Form.Item
                  name="scale"
                  label="å°æ•°ä½"
                  style={{ flex: 1 }}
                >
                  <InputNumber min={0} max={30} placeholder="å°æ•°ä½æ•°" style={{ width: '100%' }} />
                </Form.Item>
              )}
            </div>
          )}

          {/* åŸºç¡€é…ç½®é¡¹ - æ™ºèƒ½æ˜¾ç¤º */}
          <div style={{ display: 'flex', gap: 16 }}>
            {/* å¯ä¸ºç©º - æ‰€æœ‰ç±»å‹éƒ½æ˜¾ç¤ºï¼Œä½†IDç±»å‹å¼ºåˆ¶ä¸ºfalse */}
            <Form.Item
              name="nullable"
              label="å¯ä¸ºç©º"
              valuePropName="checked"
              labelCol={{ span: 12 }}
              wrapperCol={{ span: 12 }}
              style={{ flex: 1 }}
            >
              <Switch 
                disabled={formValues.type ? isIDType(formValues.type) : false}
              />
            </Form.Item>

            {/* å”¯ä¸€çº¦æŸ - æ ¹æ®ç±»å‹æ™ºèƒ½æ˜¾ç¤º */}
            {formValues.type && shouldShowConfig(formValues.type, 'unique') && (
              <Form.Item
                name="unique"
                label="å”¯ä¸€çº¦æŸ"
                valuePropName="checked"
                labelCol={{ span: 12 }}
                wrapperCol={{ span: 12 }}
                style={{ flex: 1 }}
              >
                <Switch />
              </Form.Item>
            )}

            {/* ä¸»é”® - æ ¹æ®ç±»å‹æ™ºèƒ½æ˜¾ç¤º */}
            {formValues.type && shouldShowConfig(formValues.type, 'primary') && (
              <Form.Item
                name="primary"
                label="ä¸»é”®"
                valuePropName="checked"
                labelCol={{ span: 12 }}
                wrapperCol={{ span: 12 }}
                style={{ flex: 1 }}
              >
                <Switch />
              </Form.Item>
            )}
          </div>         

          {/* ADB æ‰©å±•ç±»å‹é…ç½® - ä½¿ç”¨æ¡ä»¶æ¸²æŸ“ï¼Œé¿å…ç©ºç™½ Form.Item */}
          
          {/* ADB Media é…ç½® */}
          {formValues.type && shouldShowConfig(formValues.type, 'mediaConfig') && (
            <div>
              <Form.Item
                name={['mediaConfig', 'mediaType']}
                label="åª’ä½“ç±»å‹"
                rules={[{ required: true, message: 'è¯·é€‰æ‹©åª’ä½“ç±»å‹' }]}
              >
                <Select placeholder="é€‰æ‹©åª’ä½“ç±»å‹">
                  <Option value="image">å›¾ç‰‡</Option>
                  <Option value="video">è§†é¢‘</Option>
                  <Option value="audio">éŸ³é¢‘</Option>
                  <Option value="document">æ–‡æ¡£</Option>
                  <Option value="file">æ–‡ä»¶</Option>
                </Select>
              </Form.Item>
              
              <Form.Item
                name={['mediaConfig', 'formats']}
                label="æ”¯æŒæ ¼å¼"
                rules={[{ required: true, message: 'è¯·è¾“å…¥æ”¯æŒçš„æ–‡ä»¶æ ¼å¼' }]}
              >
                <Select mode="tags" placeholder="è¾“å…¥æ–‡ä»¶æ ¼å¼ï¼Œå¦‚: jpg, png, gif">
                  <Option value="jpg">JPG</Option>
                  <Option value="png">PNG</Option>
                  <Option value="gif">GIF</Option>
                  <Option value="webp">WEBP</Option>
                  <Option value="mp4">MP4</Option>
                  <Option value="pdf">PDF</Option>
                </Select>
              </Form.Item>
              
              <div style={{ display: 'flex', gap: 16 }}>
                <Form.Item
                  name={['mediaConfig', 'maxSize']}
                  label="æœ€å¤§é™åˆ¶(MB)"
                  style={{ flex: 1 }}
                  labelCol={{ span: 12 }}
                  wrapperCol={{ span: 12 }}
                >
                  <InputNumber min={1} placeholder="æ–‡ä»¶å¤§å°é™åˆ¶" style={{ width: '100%' }} />
                </Form.Item>
                
                <Form.Item
                  name={['mediaConfig', 'isMultiple']}
                  label="å…è®¸å¤šæ–‡ä»¶"
                  valuePropName="checked"
                  style={{ flex: 1 }}
                  labelCol={{ span: 12 }}
                  wrapperCol={{ span: 12 }}
                >
                  <Switch />
                </Form.Item>
              </div>
              
              <Form.Item
                name={['mediaConfig', 'storagePath']}
                label="å­˜å‚¨è·¯å¾„"
              >
                <Input placeholder="ä¾‹å¦‚: uploads/avatars" />
              </Form.Item>
            </div>
          )}
          
          {/* ADB Enum é…ç½® */}
          {formValues.type && shouldShowConfig(formValues.type, 'enumConfig') && (
            <div>
              <Form.Item
                name={['enumConfig', 'enum']}
                label="é€‰æ‹©æšä¸¾"
                rules={[{ required: true, message: 'è¯·é€‰æ‹©æšä¸¾' }]}
              >
                <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                    <span style={{ flex: 1, color: "#177ddc" }}>
                      {selectedEnumCode ? enumDisplayText : 'æœªé€‰æ‹©'}
                    </span>
                    {selectedEnumCode ? (
                      <Button 
                        type="link" 
                        size="small" 
                        onClick={handleEnumClear}
                        style={{ padding: 0, color: '#888' }}
                      >
                        æ¸…ç©ºé€‰æ‹©
                      </Button>
                    ) : (
                      <Button 
                        type="primary" 
                        size="small" 
                        onClick={() => setIsEnumSelectModalVisible(true)}
                      >
                        è¯·é€‰æ‹©
                      </Button>
                    )}
                </div>
              </Form.Item>
              
              <Form.Item
                name={['enumConfig', 'isMultiple']}
                label="å¤šé€‰æ¨¡å¼"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
              
              {/* <Form.Item
                name={['enumConfig', 'default']}
                label="é»˜è®¤å€¼"
              >
                {(() => {
                  const enumOptions = getCurrentEnumOptions();
                  const defaultValueOptions = getDefaultValueOptions(formValues.type, enumOptions);
                  
                  if (defaultValueOptions && defaultValueOptions.length > 1) {
                    return (
                      <Select placeholder="é€‰æ‹©é»˜è®¤å€¼" showSearch>
                        {defaultValueOptions.map(option => (
                          <Option key={option.value} value={option.value}>
                            {option.label}
                          </Option>
                        ))}
                      </Select>
                    );
                  }
                  return <Input placeholder="æšä¸¾é»˜è®¤å€¼" />;
                })()}
              </Form.Item> */}
            </div>
          )}
          
          {/* Auto Increment ID é…ç½® */}
          {formValues.type && shouldShowConfig(formValues.type, 'autoIncrementIdConfig') && (
            <div>
              <div style={{ display: 'flex', gap: 16 }}>
                <Form.Item
                  name={['autoIncrementIdConfig', 'startValue']}
                  label="èµ·å§‹å€¼"
                  style={{ flex: 1 }}
                >
                  <InputNumber min={1} placeholder="èµ·å§‹å€¼" style={{ width: '100%' }} />
                </Form.Item>
                
                <Form.Item
                  name={['autoIncrementIdConfig', 'increment']}
                  label="å¢é‡"
                  style={{ flex: 1 }}
                >
                  <InputNumber min={1} placeholder="å¢é‡" style={{ width: '100%' }} />
                </Form.Item>
              </div>
              
              <Form.Item
                name={['autoIncrementIdConfig', 'sequenceName']}
                label="åºåˆ—åç§°"
              >
                <Input placeholder="PostgreSQLåºåˆ—åç§°" />
              </Form.Item>
              
              <Form.Item
                name={['autoIncrementIdConfig', 'isPrimaryKey']}
                label="æ˜¯å¦ä¸»é”®"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </div>
          )}
          
          {/* GUID ID é…ç½® */}
          {formValues.type && shouldShowConfig(formValues.type, 'guidIdConfig') && (
            <div>
              <Space style={{ width: '100%' }}>
                <Form.Item
                  name={['guidIdConfig', 'version']}
                  label="GUIDç‰ˆæœ¬"
                  style={{ flex: 1 }}
                >
                  <Select placeholder="é€‰æ‹©ç‰ˆæœ¬">
                    <Option value="v1">V1 - åŸºäºæ—¶é—´æˆ³</Option>
                    <Option value="v4">V4 - éšæœºï¼ˆæ¨èï¼‰</Option>
                    <Option value="v5">V5 - åŸºäºå‘½åç©ºé—´</Option>
                  </Select>
                </Form.Item>
                
                <Form.Item
                  name={['guidIdConfig', 'format']}
                  label="æ ¼å¼"
                  style={{ flex: 1 }}
                >
                  <Select placeholder="é€‰æ‹©æ ¼å¼">
                    <Option value="default">æ ‡å‡†æ ¼å¼</Option>
                    <Option value="braced">å¤§æ‹¬å·æ ¼å¼</Option>
                    <Option value="binary">äºŒè¿›åˆ¶æ ¼å¼</Option>
                    <Option value="urn">URNæ ¼å¼</Option>
                  </Select>
                </Form.Item>
              </Space>
              
              <Form.Item
                name={['guidIdConfig', 'isPrimaryKey']}
                label="æ˜¯å¦ä¸»é”®"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
              
              <Form.Item
                name={['guidIdConfig', 'generateOnInsert']}
                label="æ’å…¥æ—¶è‡ªåŠ¨ç”Ÿæˆ"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </div>
          )}
          
          {/* Snowflake ID é…ç½® */}
          {formValues.type && shouldShowConfig(formValues.type, 'snowflakeIdConfig') && (
            <div>
              <div style={{ display: 'flex', gap: 16 }}>
                <Form.Item
                  name={['snowflakeIdConfig', 'machineId']}
                  label="æœºå™¨ID"
                  style={{ flex: 1 }}
                >
                  <InputNumber min={0} max={1023} placeholder="0-1023" style={{ width: '100%' }} />
                </Form.Item>
                
                <Form.Item
                  name={['snowflakeIdConfig', 'datacenterId']}
                  label="æ•°æ®ä¸­å¿ƒID"
                  style={{ flex: 1 }}
                >
                  <InputNumber min={0} max={31} placeholder="0-31" style={{ width: '100%' }} />
                </Form.Item>
              </div>
              
              <div style={{ display: 'flex', gap: 16 }}>
                <Form.Item
                  name={['snowflakeIdConfig', 'format']}
                  label="è¾“å‡ºæ ¼å¼"
                  style={{ flex: 1 }}
                >
                  <Select placeholder="é€‰æ‹©æ ¼å¼">
                    <Option value="number">æ•°å­—æ ¼å¼ï¼ˆæ¨èï¼‰</Option>
                    <Option value="string">å­—ç¬¦ä¸²æ ¼å¼</Option>
                  </Select>
                </Form.Item>
                
                <Form.Item
                  name={['snowflakeIdConfig', 'isPrimaryKey']}
                  label="æ˜¯å¦ä¸»é”®"
                  valuePropName="checked"
                  style={{ flex: 1 }}
                >
                  <Switch />
                </Form.Item>
              </div>
              
              <Form.Item
                name={['snowflakeIdConfig', 'generateOnInsert']}
                label="æ’å…¥æ—¶è‡ªåŠ¨ç”Ÿæˆ"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </div>
          )}

          {/* é»˜è®¤å€¼ - æ ¹æ®ç±»å‹æ™ºèƒ½æ˜¾ç¤º */}
          {formValues.type && shouldShowConfig(formValues.type, 'default') && (
            <Form.Item
              name="default"
              label="é»˜è®¤å€¼"
            >
              {(() => {
                const enumOptions = getCurrentEnumOptions();
                const defaultValueOptions = getDefaultValueOptions(formValues.type, enumOptions);
                if (defaultValueOptions) {
                  return (
                    <Select 
                      placeholder="é€‰æ‹©æˆ–è¾“å…¥é»˜è®¤å€¼" 
                      allowClear
                      showSearch
                      filterOption={(input, option) => {
                        // å…è®¸æœç´¢é€‰é¡¹
                        return option?.children?.toString().toLowerCase().includes(input.toLowerCase()) || false;
                      }}
                      popupRender={(menu) => (
                        <div>
                          {menu}
                          <div style={{ padding: '8px 12px', fontSize: '12px', color: '#666' }}>
                            ğŸ’¡ æ‚¨å¯ä»¥ç›´æ¥è¾“å…¥è‡ªå®šä¹‰å€¼
                          </div>
                        </div>
                      )}
                    >
                      {defaultValueOptions.map(option => (
                        <Option key={option.value} value={option.value}>
                          {option.label}
                        </Option>
                      ))}
                    </Select>
                  );
                }
                return <Input placeholder="å­—æ®µé»˜è®¤å€¼ï¼ˆå¯é€‰ï¼‰" />;
              })()}
            </Form.Item>
          )}
          
          {/* å…³ç³»é…ç½® - ä»…å¯¹æ”¯æŒå…³ç³»é…ç½®çš„å­—æ®µç±»å‹æ˜¾ç¤º */}
          {formValues.type && supportsRelationConfig(formValues.type) && (
            <div style={{ 
              border: '1px solid #424242', 
              borderRadius: 6, 
              padding: 16, 
              marginTop: 16,
              backgroundColor: '#1f1f1f'
            }}>
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'center', 
                marginBottom: 16 
              }}>
                <div style={{ fontWeight: 'bold', color: '#1890ff' }}>
                  ğŸ”— å…³ç³»é…ç½®
                </div>
                <Form.Item 
                  name="enableRelation" 
                  valuePropName="checked" 
                  noStyle
                >
                  <Switch />
                </Form.Item>
              </div>
              
              <Form.Item 
                noStyle 
                shouldUpdate={(prevValues, currentValues) => 
                  prevValues.enableRelation !== currentValues.enableRelation
                }
              >
                {({ getFieldValue }) => 
                  getFieldValue('enableRelation') && (
                    <>
                      <Form.Item
                        name="relationType"
                        label="å…³ç³»ç±»å‹"
                        rules={[{ required: true, message: 'è¯·é€‰æ‹©å…³ç³»ç±»å‹' }]}
                      >
                        <Select placeholder="é€‰æ‹©å…³ç³»ç±»å‹">
                          <Option value="manyToOne">å¤šå¯¹ä¸€ (ManyToOne)</Option>
                          <Option value="oneToOne">ä¸€å¯¹ä¸€ (OneToOne)</Option>
                        </Select>
                      </Form.Item>
                      
                      <Form.Item
                        name="targetEntity"
                        label="ç›®æ ‡å®ä½“"
                        rules={[{ required: true, message: 'è¯·é€‰æ‹©ç›®æ ‡å®ä½“' }]}
                      >
                        <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
                          <span style={{ flex: 1, color: '#177ddc' }}>
                            {getFieldValue('targetEntityName') || 'æœªé€‰æ‹©å®ä½“'}
                          </span>
                          <Button 
                            type="primary" 
                            size="small" 
                            onClick={() => setIsEntitySelectModalVisible(true)}
                          >
                            é€‰æ‹©å®ä½“
                          </Button>
                        </div>
                      </Form.Item>
                      
                      <Form.Item
                        name="targetField"
                        label="ç›®æ ‡å­—æ®µ"
                        rules={[{ required: true, message: 'è¯·é€‰æ‹©ç›®æ ‡å­—æ®µ' }]}
                      >
                        <Select placeholder="é€‰æ‹©ç›®æ ‡å­—æ®µ">
                          {getFieldOptionsForEntity(getFieldValue('targetEntity')).map(option => (
                            <Option key={option.value} value={option.value}>
                              {option.label}
                            </Option>
                          ))}
                        </Select>
                      </Form.Item>
                      
                      <Form.Item
                        name="relationName"
                        label="å…³ç³»åç§°"
                      >
                        <Input placeholder="ä¾‹å¦‚: user, orders" />
                      </Form.Item>
                    </>
                  )
                }
              </Form.Item>
            </div>
          )
        }
        </Form>
      </Modal>

      {/* å…³ç³»ç®¡ç†æ¨¡æ€æ¡† */}
      <Modal
        title="å…³ç³»ç®¡ç†"
        open={isRelationModalVisible}
        onCancel={() => setIsRelationModalVisible(false)}
        footer={null}
        width={1200}
        destroyOnHidden
        maskClosable={false}
      >
        <RelationManager 
          project={project}
          onProjectUpdate={onEntityUpdate}
        />
      </Modal>

      {/* ADBæšä¸¾ç®¡ç†æ¨¡æ€æ¡† */}
      <ADBEnumManager
        visible={isEnumModalVisible}
        onClose={() => setIsEnumModalVisible(false)}
        project={project}
        onProjectUpdate={onEntityUpdate}
      />

      {/* æšä¸¾é€‰æ‹©æ¨¡æ€æ¡† */}
      <EnumSelectModal
        visible={isEnumSelectModalVisible}
        onCancel={() => setIsEnumSelectModalVisible(false)}
        onConfirm={(enumCode) => {
          if (enumCode) {
            handleEnumSelect(enumCode);
            setIsEnumSelectModalVisible(false);
          } else {
            message.warning("è¯·é€‰æ‹©ä¸€ä¸ªæšä¸¾");
          }
        }}
        project={project}
        selectedEnumCode={selectedEnumCode}
      />
      
      {/* å®ä½“é€‰æ‹©æ¨¡æ€æ¡† */}
      <EntitySelectModal
        visible={isEntitySelectModalVisible}
        onCancel={() => setIsEntitySelectModalVisible(false)}
        onConfirm={(entityId, entityName) => {
          form.setFieldsValue({
            targetEntity: entityId,
            targetEntityName: entityName
          });
          setIsEntitySelectModalVisible(false);
        }}
        project={project}
      />

      {/* å…³ç³»åˆ›å»ºæ¨¡æ€æ¡† */}
      <Modal
        title={editingRelationInFields ? 'ç¼–è¾‘å…³ç³»' : 'æ–°å»ºå…³ç³»'}
        open={isRelationCreateModalVisible}
        onOk={handleSaveRelation}
        onCancel={() => {
          setIsRelationCreateModalVisible(false);
          setEditingRelationInFields(null);
          setRelationValidationResult(null);
          setRelationConflicts([]);
        }}
        width={800}
        okText="ä¿å­˜"
        cancelText="å–æ¶ˆ"
        maskClosable={false}
        destroyOnHidden
      >
        <Form
          form={relationForm}
          layout="vertical"
          onFinish={handleSaveRelation}
          initialValues={{
            cascade: false,
            onDelete: CascadeType.RESTRICT,
            onUpdate: CascadeType.RESTRICT,
            nullable: true,
            eager: false,
            lazy: true,
          }}
          style={{ paddingTop: 30 }}
        >
          {/* åŸºæœ¬ä¿¡æ¯ */}
          <Title level={5}>åŸºæœ¬ä¿¡æ¯</Title>
          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="type"
                label="å…³ç³»ç±»å‹"
                rules={[{ required: true, message: 'è¯·é€‰æ‹©å…³ç³»ç±»å‹' }]}
              >
                <Select placeholder="é€‰æ‹©å…³ç³»ç±»å‹">
                  <Option value={RelationType.ONE_TO_ONE}>ä¸€å¯¹ä¸€ (OneToOne)</Option>
                  <Option value={RelationType.ONE_TO_MANY}>ä¸€å¯¹å¤š (OneToMany)</Option>
                  <Option value={RelationType.MANY_TO_ONE}>å¤šå¯¹ä¸€ (ManyToOne)</Option>
                  <Option value={RelationType.MANY_TO_MANY}>å¤šå¯¹å¤š (ManyToMany)</Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="name"
                label="å…³ç³»åç§°"
                rules={[{ required: true, message: 'è¯·è¾“å…¥å…³ç³»åç§°' }]}
              >
                <Input placeholder="å…³ç³»åç§°" />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="fromEntityId"
                label="æºå®ä½“"
                rules={[{ required: true, message: 'è¯·é€‰æ‹©æºå®ä½“' }]}
              >
                <Select placeholder="é€‰æ‹©æºå®ä½“" disabled={!!editingRelationInFields}>
                  {entities.map(entity => (
                    <Option key={entity.entityInfo.id} value={entity.entityInfo.id}>
                      {entity.entityInfo.label || entity.entityInfo.code}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="toEntityId"
                label="ç›®æ ‡å®ä½“"
                rules={[{ required: true, message: 'è¯·é€‰æ‹©ç›®æ ‡å®ä½“' }]}
              >
                <Select placeholder="é€‰æ‹©ç›®æ ‡å®ä½“">
                  {entities.map(entity => (
                    <Option key={entity.entityInfo.id} value={entity.entityInfo.id}>
                      {entity.entityInfo.label || entity.entityInfo.code}
                    </Option>
                  ))}
                </Select>
              </Form.Item>
            </Col>
          </Row>

          <Form.Item
            name="inverseName"
            label="åå‘å…³ç³»åç§°"
          >
            <Input placeholder="åå‘å…³ç³»åç§°ï¼ˆå¯é€‰ï¼‰" />
          </Form.Item>

          <Form.Item
            name="description"
            label="å…³ç³»æè¿°"
          >
            <Input.TextArea placeholder="å…³ç³»æè¿°ï¼ˆå¯é€‰ï¼‰" rows={3} />
          </Form.Item>

          {/* å…³ç³»é…ç½® */}
          <Divider />
          <Title level={5}>å…³ç³»é…ç½®</Title>
          <Row gutter={16}>
            <Col span={8}>
              <Form.Item
                name="cascade"
                label="çº§è”æ“ä½œ"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="nullable"
                label="å¯ä¸ºç©º"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
            <Col span={8}>
              <Form.Item
                name="eager"
                label="ç«‹å³åŠ è½½"
                valuePropName="checked"
              >
                <Switch />
              </Form.Item>
            </Col>
          </Row>

          <Row gutter={16}>
            <Col span={12}>
              <Form.Item
                name="onDelete"
                label="åˆ é™¤ç­–ç•¥"
              >
                <Select>
                  <Option value={CascadeType.CASCADE}>çº§è” (CASCADE)</Option>
                  <Option value={CascadeType.SET_NULL}>è®¾ä¸ºç©º (SET NULL)</Option>
                  <Option value={CascadeType.RESTRICT}>é™åˆ¶ (RESTRICT)</Option>
                  <Option value={CascadeType.NO_ACTION}>æ— æ“ä½œ (NO ACTION)</Option>
                </Select>
              </Form.Item>
            </Col>
            <Col span={12}>
              <Form.Item
                name="onUpdate"
                label="æ›´æ–°ç­–ç•¥"
              >
                <Select>
                  <Option value={CascadeType.CASCADE}>çº§è” (CASCADE)</Option>
                  <Option value={CascadeType.SET_NULL}>è®¾ä¸ºç©º (SET NULL)</Option>
                  <Option value={CascadeType.RESTRICT}>é™åˆ¶ (RESTRICT)</Option>
                  <Option value={CascadeType.NO_ACTION}>æ— æ“ä½œ (NO ACTION)</Option>
                </Select>
              </Form.Item>
            </Col>
          </Row>

          {/* å¤šå¯¹å¤šå…³ç³»é…ç½® */}
          {relationForm.getFieldValue('type') === RelationType.MANY_TO_MANY && (
            <>
              <Divider />
              <Title level={5}>ä¸­é—´è¡¨é…ç½®</Title>
              <Row gutter={16}>
                <Col span={8}>
                  <Form.Item
                    name="joinTableName"
                    label="ä¸­é—´è¡¨åç§°"
                    rules={[{ required: true, message: 'è¯·è¾“å…¥ä¸­é—´è¡¨åç§°' }]}
                  >
                    <Input placeholder="ä¸­é—´è¡¨åç§°" />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item
                    name="joinColumn"
                    label="è¿æ¥åˆ—åç§°"
                    rules={[{ required: true, message: 'è¯·è¾“å…¥è¿æ¥åˆ—åç§°' }]}
                  >
                    <Input placeholder="è¿æ¥åˆ—åç§°" />
                  </Form.Item>
                </Col>
                <Col span={8}>
                  <Form.Item
                    name="inverseJoinColumn"
                    label="åå‘è¿æ¥åˆ—åç§°"
                    rules={[{ required: true, message: 'è¯·è¾“å…¥åå‘è¿æ¥åˆ—åç§°' }]}
                  >
                    <Input placeholder="åå‘è¿æ¥åˆ—åç§°" />
                  </Form.Item>
                </Col>
              </Row>
            </>
          )}

          {/* éªŒè¯ç»“æœ */}
          {relationValidationResult && (
            <>
              <Divider />
              <Title level={5}>éªŒè¯ç»“æœ</Title>
              {relationValidationResult.errors.length > 0 && (
                <Alert
                  message="éªŒè¯é”™è¯¯"
                  description={
                    <ul style={{ margin: 0, paddingLeft: 20 }}>
                      {relationValidationResult.errors.map((error, index) => (
                        <li key={index}>{error.message}</li>
                      ))}
                    </ul>
                  }
                  type="error"
                  showIcon
                  style={{ marginBottom: 16 }}
                />
              )}
              {relationValidationResult.warnings.length > 0 && (
                <Alert
                  message="éªŒè¯è­¦å‘Š"
                  description={
                    <ul style={{ margin: 0, paddingLeft: 20 }}>
                      {relationValidationResult.warnings.map((warning, index) => (
                        <li key={index}>{warning.message}</li>
                      ))}
                    </ul>
                  }
                  type="warning"
                  showIcon
                  style={{ marginBottom: 16 }}
                />
              )}
              {relationValidationResult.isValid && relationValidationResult.errors.length === 0 && (
                <Alert
                  message="éªŒè¯é€šè¿‡"
                  description="å…³ç³»é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥ä¿å­˜ã€‚"
                  type="success"
                  showIcon
                  style={{ marginBottom: 16 }}
                />
              )}
            </>
          )}

          {/* å†²çªæ£€æµ‹ */}
          {relationConflicts.length > 0 && (
            <>
              <Divider />
              <Title level={5}>å†²çªæ£€æµ‹</Title>
              <Alert
                message="æ£€æµ‹åˆ°å…³ç³»å†²çª"
                description={
                  <ul style={{ margin: 0, paddingLeft: 20 }}>
                    {relationConflicts.map((conflict, index) => (
                      <li key={index}>
                        {conflict.message}
                        {conflict.suggestion && (
                          <div style={{ color: '#666', fontSize: '12px' }}>
                            å»ºè®®ï¼š{conflict.suggestion}
                          </div>
                        )}
                      </li>
                    ))}
                  </ul>
                }
                type="error"
                showIcon
                style={{ marginBottom: 16 }}
              />
            </>
          )}
        </Form>
      </Modal>
    </div>
  );



  // å¤„ç†ä¿å­˜å…³ç³»
  const handleSaveRelation = async () => {
    try {
      const values = await relationForm.validateFields();
      
      const config: RelationCreateConfig = {
        type: values.type,
        fromEntityId: values.fromEntityId || entity.entityInfo.id, // å¦‚æœæ²¡æœ‰é€‰æ‹©æºå®ä½“ï¼Œé»˜è®¤ä¸ºå½“å‰å®ä½“

